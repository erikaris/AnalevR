<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AnalevR - An R Analysis Environment</title>
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/4.0.0-18/css/ionicons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jvectormap/1.2.2/jquery-jvectormap.min.css">
    <link rel="stylesheet" href="https://adminlte.io/themes/AdminLTE/dist/css/AdminLTE.min.css">
    <link rel="stylesheet" href="https://adminlte.io/themes/AdminLTE/dist/css/skins/_all-skins.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/css/bootstrap-editable.css"/>

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript">
        (function ($) {
            $.fn.codemirror = function (options) {
                var result = this;

                var settings = $.extend({
                    'mode': 'javascript',
                    'lineNumbers': false,
                    'runmode': false
                }, options);

                if (settings.runmode) this.each(function () {
                    var obj = $(this);
                    var accum = [],
                        gutter = [],
                        size = 0;
                    var callback = function (string, style) {
                        if (string == "\n") {
                            accum.push("<br>");
                            gutter.push('<pre>' + (++size) + '</pre>');
                        } else if (style) {
                            accum.push("<span class=\"cm-" + CodeMirror.htmlEscape(style) + "\">" +
                                CodeMirror.htmlEscape(string) + "</span>");
                        } else {
                            accum.push(CodeMirror.htmlEscape(string));
                        }
                    }
                    CodeMirror.runMode(obj.val(), settings.mode, callback);
                    $('<div class="CodeMirror">' + (settings.lineNumbers ? (
                            '<div class="CodeMirror-gutter"><div class="CodeMirror-gutter-text">' +
                            gutter.join('') + '</div></div>') : '<!--gutter-->') +
                        '<div class="CodeMirror-lines">' + (settings.lineNumbers ?
                            '<div style="position: relative; margin-left: ' + size.toString().length +
                            'em;">' : '<div>') + '<pre class="cm-s-default">' + accum.join('') +
                        '</pre></div></div></div>').insertAfter(obj);
                    obj.hide();
                });
                else this.each(function () {
                    result = CodeMirror.fromTextArea(this, settings);
                    $(this).data('codemirror', result);
                });

                return result;
            };
        })(jQuery);

        var waitingDialog = waitingDialog || (function ($) {
            'use strict';

            // Creating modal dialog's DOM
            var $dialog = $(
                '<div class="modal fade" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true" style="padding-top:15%; overflow-y:visible;">' +
                '<div class="modal-dialog modal-m">' +
                '<div class="modal-content">' +
                    '<div class="modal-header"><h3 style="margin:0;"></h3></div>' +
                    '<div class="modal-body">' +
                        '<div class="progress progress-striped active" style="margin-bottom:0;"><div class="progress-bar" style="width: 100%"></div></div>' +
                    '</div>' +
                '</div></div></div>');

            return {
                show: function (message, options) {
                    // Assigning defaults
                    if (typeof options === 'undefined') {
                        options = {};
                    }
                    if (typeof message === 'undefined') {
                        message = 'Loading';
                    }
                    var settings = $.extend({
                        dialogSize: 'm',
                        progressType: '',
                        onHide: null // This callback runs after the dialog was hidden
                    }, options);

                    // Configuring dialog
                    $dialog.find('.modal-dialog').attr('class', 'modal-dialog').addClass('modal-' + settings.dialogSize);
                    $dialog.find('.progress-bar').attr('class', 'progress-bar');
                    if (settings.progressType) {
                        $dialog.find('.progress-bar').addClass('progress-bar-' + settings.progressType);
                    }
                    $dialog.find('h3').text(message);

                    // Adding callbacks
                    if (typeof settings.onHide === 'function') {
                        $dialog.off('hidden.bs.modal').on('hidden.bs.modal', function (e) {
                            settings.onHide.call($dialog);
                        });
                    }
                    // Opening dialog
                    $dialog.modal();
                    return $dialog;
                },
                hide: function () {
                    $dialog.modal('hide');
                    return $dialog;
                }
            };
        })(jQuery);
    </script>

    <style>
        .content-header > .breadcrumb {
            padding: 0 10px 0 0;
        }
        .content-header > .breadcrumb button{
            font-size: 20px;
        }
        .box-header {
            cursor: move;
            cursor: -webkit-grabbing;
        }
        .output-wrapper [class*="output-"] {
            display: none;
        }
        .CodeMirror {
            height: auto !important;
            font-size: 12px !important;
        }
        .CodeMirror-scroll {
            height: auto !important;
            overflow-y: hidden !important;
            overflow-x: auto !important;
        }
    </style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
    <div class="wrapper">
        <header class="main-header">
            <!-- Logo -->
            <a href="." class="logo">
                <span class="logo-mini"><b>AeR</b></span>
                <span class="logo-lg">Analev<b>R</b></span>
            </a>

            <!-- Header Navbar: style can be found in header.less -->
            <nav class="navbar navbar-static-top">
                <!-- Sidebar toggle button-->
                <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
                    <span class="sr-only">Toggle navigation</span>
                </a>

                <!-- Navbar Right Menu -->
                <div class="navbar-custom-menu">
                    <ul class="nav navbar-nav">
                        <!-- User Account: style can be found in dropdown.less -->
                        <li class="dropdown user user-menu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <img src="https://adminlte.io/themes/AdminLTE/dist/img/user2-160x160.jpg" class="user-image"
                                     alt="User Image">
                                <span class="hidden-xs">Alexander Pierce</span>
                            </a>
                            <ul class="dropdown-menu">
                                <!-- User image -->
                                <li class="user-header">
                                    <img src="https://adminlte.io/themes/AdminLTE/dist/img/user2-160x160.jpg"
                                         class="img-circle" alt="User Image">

                                    <p>
                                        Alexander Pierce - Web Developer
                                        <small>Member since Nov. 2012</small>
                                    </p>
                                </li>
                                <!-- Menu Body -->
                                <li class="user-body">
                                    <div class="row">
                                        <div class="col-xs-4 text-center">
                                            <a href="#">Followers</a>
                                        </div>
                                        <div class="col-xs-4 text-center">
                                            <a href="#">Sales</a>
                                        </div>
                                        <div class="col-xs-4 text-center">
                                            <a href="#">Friends</a>
                                        </div>
                                    </div>
                                    <!-- /.row -->
                                </li>
                                <!-- Menu Footer-->
                                <li class="user-footer">
                                    <div class="pull-left">
                                        <a href="#" class="btn btn-default btn-flat">Profile</a>
                                    </div>
                                    <div class="pull-right">
                                        <a href="#" class="btn btn-default btn-flat">Sign out</a>
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Left side column. contains the logo and sidebar -->
        <aside class="main-sidebar">
            <!-- sidebar: style can be found in sidebar.less -->
            <section class="sidebar">
                <!-- Sidebar user panel -->
                <div class="user-panel">
                    <div class="pull-left image">
                        <img src="https://adminlte.io/themes/AdminLTE/dist/img/user2-160x160.jpg" class="img-circle"
                             alt="User Image">
                    </div>
                    <div class="pull-left info">
                        <p>Alexander Pierce</p>
                        <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
                    </div>
                </div>

                <!-- search form -->
                <form action="#" method="get" class="sidebar-form">
                    <div class="input-group">
                        <input type="text" name="q" class="form-control" placeholder="Search...">
                        <span class="input-group-btn">
                    <button type="submit" name="search" id="search-btn" class="btn btn-flat">
                      <i class="fa fa-search"></i>
                    </button>
                  </span>
                    </div>
                </form>

                <!-- sidebar menu: : style can be found in sidebar.less -->
                <ul class="sidebar-menu" data-widget="tree">
                    <li class="header">MAIN NAVIGATION</li>
                    <li class="active treeview menu-open">
                        <a href="#">
                            <i class="fa fa-dashboard"></i> <span>Workspaces</span>
                            <span class="pull-right-container">
                                <i class="fa fa-angle-left pull-right"></i>
                            </span>
                        </a>
                        <ul class="treeview-menu list-workspaces"></ul>
                    </li>
                </ul>
            </section>
            <!-- /.sidebar -->
        </aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <h1>
                    <a href="#" id="notebook-name">{{ session.label }}</a> <small>Unsaved</small>
                </h1>

                <div class="breadcrumb">
                    <button type="button" class="btn btn-box-tool" data-widget="save">
                        <i class="fa fa-save"></i>
                    </button>
                    <button type="button" class="btn btn-box-tool" data-widget="trash">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </section>

            <!-- Main content -->
            <section class="content">
                <div class="row">
                    <div class="col-md-12 paragraph">
                        <div class="box">
                            <div class="box-header with-border">
                                <h3 class="box-title"><a href="#" class="paragraph-title">Untitled Paragraph</a></h3>

                                <div class="box-tools pull-right">
                                    <button type="button" class="btn btn-box-tool" data-widget="run">
                                        <i class="fa fa-play"></i>
                                    </button>
                                    <button type="button" class="btn btn-box-tool" data-widget="copy">
                                        <i class="fa fa-copy"></i>
                                    </button>
                                    <button type="button" class="btn btn-box-tool" data-widget="collapse">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                    <button type="button" class="btn btn-box-tool" data-widget="remove">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="box-body">
                                <div class="row input-wrapper">
                                    <div class="col-md-12">
                                        <textarea style="display:none;" class="paragraph-input"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="box-footer">
                                <div class="row output-wrapper">
                                    <div class="col-sm-12 col-xs-12 output-table"></div>
                                    <div class="col-sm-12 col-xs-12 output-image"></div>
                                    <div class="col-sm-12 col-xs-12 output-plain">
                                        <textarea style="display:none;" class="paragraph-output"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="box-footer">
                                <div class="row time-wrapper">
                                    <div class="col-sm-12 col-xs-12">
                                        Command is executed in <span class="sp-et"></span> ms.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <footer class="main-footer">
            <div class="pull-right hidden-xs">
                <b>Version</b> 0.1
            </div>
            <strong>Copyright &copy; 2018 <a href="http://erikaris.com/">Erikaris</a>. Design by <a href="https://adminlte.io">Admin LTE</a>.</strong>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script src="https://adminlte.io/themes/AdminLTE/dist/js/adminlte.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jvectormap/1.2.2/jquery-jvectormap.min.js"></script>
    <script src="https://adminlte.io/themes/AdminLTE/plugins/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-slimScroll/1.3.8/jquery.slimscroll.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.6.0/Sortable.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/mode/r/r.min.js"></script>

    <script src="https://adminlte.io/themes/AdminLTE/dist/js/pages/dashboard2.js"></script>
    <script src="https://adminlte.io/themes/AdminLTE/dist/js/demo.js"></script>

    <script type="text/javascript">
        $('.input-wrapper textarea').codemirror({
            'mode': 'r',
            'lineNumbers': true,
            'indentUnit': 2,
            'tabSize': 2,
            'indentWithTabs': true,
        });

        $(document).ready(function() {
            $.fn.editable.defaults.mode = 'inline';
            $('#notebook-name').editable({
                type: 'text',
                pk: '{{ session_id }}',
                url: '{{ base_url }}/api/session/title',
                title: 'Enter notebook name'
            });

            $('.paragraph-title').editable({
                type: 'text',
                pk: '{{ session_id }}',
                url: '{{ base_url }}/api/session/fake',
                title: 'Enter paragraph name'
            });

            Sortable.create($('.content .row')[0], {
                handle: ".box-header"
            });

            $dialog = $('<div class="modal fade" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-hidden="true" style="padding-top:15%; overflow-y:visible;">' +
                '<div class="modal-dialog modal-m">' +
                '<div class="modal-content">' +
                    '<div class="modal-header"><h3 style="margin:0;">Starting workspace...</h3></div>' +
                    '<div class="modal-body">' +
                        '<div class="progress progress-striped active" style="margin-bottom:0;"><div class="progress-bar" style="width: 100%"></div></div>' +
                    '</div>' +
                '</div></div></div>');

            $dialog.modal();

            $.post('{{ base_url }}/api/session/start/{{ session_id }}', {
                'user_id': '{{ user_id }}'
            }, function(resp) {
                if (resp.success) $dialog.modal('hide');
            });

            $.ajax('{{ base_url }}/api/session/list').done(function(resp) {
                if (resp.success) {
                    resp.data.forEach(function(sess) {
                        $('<li' + (sess.id == '{{ session_id }}' ? ' class="active"' : '') + '><a href="{{ base_url }}/session/' + sess.id + '"><i class="fa fa-circle-o"></i>' +
                        sess.label + '</a></li>').appendTo($('.list-workspaces'));
                    });
                }

                $('<li class="create"><a href="#"><i class="fa fa-circle-o"></i>New Workspace</a></li>').appendTo($('.list-workspaces'));
            });
        });

        $(document).on('click', '.list-workspaces .create a', function() {
            $.post('{{ base_url }}/api/session/create/', {
                'user_id': '{{ user_id }}'
            }, function(resp) {
                session_id = resp.data;
                window.open('{{ base_url }}/session/' + session_id);
            });
        });

        $(document).on('click', '.btn[data-widget=save]', function() {
            var paragraphs = [];
            $('.paragraph').each(function() {
                $title = $(this).find('.paragraph-title');
                $input = $(this).find('.paragraph-input');
                $output = $(this).find('.paragraph-output');

                paragraphs.push({
                    'title' : $title.html(),
                    'input' : $input.data('codemirror').getValue(),
                    'output' : $output.data('codemirror').getValue(),
                });
            });

            $.post('{{ base_url }}/api/session/save/{{ session_id }}', {
                'user_id': '{{ user_id }}',
                'content': JSON.stringify(paragraphs)
            }, function(resp) {

            });
        });

        $(document).on('click', '.btn[data-widget=trash]', function() {
            $.post('{{ base_url }}/api/session/delete/{{ session_id }}', {
                'user_id': '{{ user_id }}'
            }, function(resp) {

            });
        });

        $(document).on('click', '.btn[data-widget=run]', function() {
            var $btn_run = $(this);
            $btn_run.parents().each(function() {
                $par = $(this);
                if ($par.hasClass('box')) {
                    $input = $par.find('.input-wrapper textarea').data('codemirror');
                    $par.find('.output-wrapper [class*="output-"]').empty().hide();

                    $.post('{{ base_url }}/api/session/eval/{{ session_id }}', {
                        'user_id': '{{ user_id }}',
                        'cmd': $input.getValue()
                    }, function(resp) {
                        if (resp.success) {
                            var type = resp.data.type,
                                text = resp.data.text,
                                time = resp.data.time.elapsed;

                            $par = $btn_run.parents().filter(function() {
                                if ($(this).hasClass('box')) return true;
                                return false;
                            });

                            $par.find('.time-wrapper .sp-et').html(time);

                            if (type == 'table') {
                                $par.find('.output-wrapper .output-table')
                                    .html(text)
                                    .show();
                            }


                            /* $btn_run.parents().each(function() {
                                $par = $(this);
                                if ($par.hasClass('box')) {
                                    $out = $par.find('.output-wrapper');
                                    $out.find('.CodeMirror').remove();
                                    $out.find('textarea').val(resp.data).codemirror({
                                        'mode': 'r',
                                        'lineNumbers': true,
                                        'indentUnit': 2,
                                        'readOnly': true
                                    });
                                }
                            }); */
                        }
                    });
                }
            });
        });

        $(document).on('click', '.btn[data-widget=copy]', function() {
            $(this).parents().each(function() {
                $par = $(this);
                if ($par.attr('class') != null && $par.attr('class').indexOf('col-') >= 0) {
                    $cpar = $par.clone();
                    $cpar.insertAfter($par);
                    $cpar.find('.CodeMirror').remove();
                    $cpar.find('.input-wrapper textarea')
                        .val($par.find('.input-wrapper textarea').data('codemirror').getValue())
                        .codemirror({
                            'mode': 'r',
                            'lineNumbers': true,
                            'indentUnit': 2,
                            'tabSize': 2,
                            'indentWithTabs': true,
                        });
                }
            });

            $('.paragraph-title').editable({
                type: 'text',
                pk: '{{ session_id }}',
                url: '{{ base_url }}/api/session/fake',
                title: 'Enter paragraph name'
            });
        });
    </script>
</body>
</html>
