<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>AnalevR - An R Analysis Environment</title>
    <link rel="shortcut icon" href="/static/images/analev-r.ico" />
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/4.0.0-18/css/ionicons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jvectormap/1.2.2/jquery-jvectormap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.3/css/AdminLTE.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.3/css/skins/_all-skins.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.39.0/addon/scroll/simplescrollbars.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/css/bootstrap-editable.css"/>

    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript">
        function htmlDecode(input) {
            var doc = new DOMParser().parseFromString(input, "text/html");
            return doc.documentElement.textContent;
        }

        (function ($) {
            $.fn.codemirror = function (options) {
                var result = this;

                var settings = $.extend({
                    'mode': 'javascript',
                    'lineNumbers': false,
                    'runmode': false
                }, options);

                if (settings.runmode) this.each(function () {
                    var obj = $(this);
                    var accum = [],
                        gutter = [],
                        size = 0;
                    var callback = function (string, style) {
                        if (string == "\n") {
                            accum.push("<br>");
                            gutter.push('<pre>' + (++size) + '</pre>');
                        } else if (style) {
                            accum.push("<span class=\"cm-" + CodeMirror.htmlEscape(style) + "\">" +
                                CodeMirror.htmlEscape(string) + "</span>");
                        } else {
                            accum.push(CodeMirror.htmlEscape(string));
                        }
                    }
                    CodeMirror.runMode(obj.val(), settings.mode, callback);
                    $('<div class="CodeMirror">' + (settings.lineNumbers ? (
                            '<div class="CodeMirror-gutter"><div class="CodeMirror-gutter-text">' +
                            gutter.join('') + '</div></div>') : '<!--gutter-->') +
                        '<div class="CodeMirror-lines">' + (settings.lineNumbers ?
                            '<div style="position: relative; margin-left: ' + size.toString().length +
                            'em;">' : '<div>') + '<pre class="cm-s-default">' + accum.join('') +
                        '</pre></div></div></div>').insertAfter(obj);
                    obj.hide();
                });
                else this.each(function () {
                    result = CodeMirror.fromTextArea(this, settings);
                    $(this).data('codemirror', result);
                });

                return result;
            };
        })(jQuery);
    </script>

    <style>
        /* Treeview */
        .treeview-menu > li {
            position: relative;
        }
        .treeview-menu > li a.close {
            position: absolute;
            top: 0px;
            right: 0px;
            display: none;
        }
        .treeview-menu > li:hover a.close {
            display: block;
        }

        /* Loading Cover */
        .cover {
            background: white;
            position: fixed;
            width: 100%;
            height: 100%;
            display: table;
            z-index: 1049;
        }
        .cover .outer-wrapper {
            display: table-cell;
            vertical-align: middle;
        }
        .cover .inner-wrapper {
            text-align: center;
        }
        .cover .loading {
            width: 200px;
            height: 200px;
            margin: auto;
            background: url(/static/images/loading.gif);
        }
        .cover .loading-text {
            font-size: 120%;
        }

        /* Login Modal */
        .login-modal-container {
            padding: 30px;
            max-width: 350px;
            width: 100% !important;
            background-color: #F7F7F7;
            margin: 0 auto;
            border-radius: 2px;
            box-shadow: 0px 2px 2px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        .login-modal-container h1 {
            text-align: center;
            font-size: 1.8em;
        }
        .login-modal-container input[type=submit] {
            width: 100%;
            display: block;
            margin-bottom: 10px;
            position: relative;
        }
        .login-modal-container input[type=text], input[type=password] {
            height: 40px;
            font-size: 16px;
            width: 100%;
            margin-bottom: 10px;
            -webkit-appearance: none;
            background: #fff;
            border: 1px solid #d9d9d9;
            border-top: 1px solid #c0c0c0;
            padding: 0 8px;
            box-sizing: border-box;
            -moz-box-sizing: border-box;
        }
        .login-modal-container input[type=text]:hover, input[type=password]:hover {
            border: 1px solid #b9b9b9;
            border-top: 1px solid #a0a0a0;
            -moz-box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            -webkit-box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .login-modal-submit {
            height: 40px;
            border: 0px;
            color: #fff;
            text-shadow: 0 1px rgba(0,0,0,0.1);
            background-color: #4d90fe;
            font-size: 14px;
        }
        .login-modal-submit:hover {
            border: 0px;
            text-shadow: 0 1px rgba(0,0,0,0.3);
            background-color: #357ae8;
        }
        .login-modal-container a {
            text-decoration: none;
            color: #666;
            font-weight: 400;
            text-align: center;
            display: inline-block;
            opacity: 0.6;
            transition: opacity ease 0.5s;
        }
        .login-modal-container .login-error,
        .login-modal-container .registration-error {
            display: none;
        }
        .login-modal-container .registration-form {
            display: none;
        }
        .login-help {
            font-size: 12px;
        }

        /* Resend activation email */
        .ln-resend-activation-email {
            color: #eee !important;
            text-decoration: underline !important;
        }



        .user-panel>.image>img {
            background: #fff;
        }
        .content-header > .breadcrumb {
            padding: 0 10px 0 0;
        }
        .content-header > .breadcrumb button{
            font-size: 20px;
        }
        .box-header {
            cursor: move;
            cursor: -webkit-grabbing;
        }
        .output-wrapper [class*="output-"] {
            display: none;
        }
        .CodeMirror {
            height: auto !important;
            font-size: 12px !important;
        }
        /*.output-wrapper .CodeMirror {
            max-height: 300px !important;
        }*/
        .CodeMirror-scroll {
            height: auto !important;
            overflow-y: hidden !important;
            overflow-x: auto !important;
        }
        .output-wrapper img {
            max-width: 100%;
        }

        /* Data selector */
        .data-item td:first-child {
            border-top: 1px solid black;
        }
        .data-item td {
            border-bottom: 1px solid black;
            padding: 5px 0;
        }
        .data-item td:hover {
            background: #e2e2e2;
        }

        .ls-data {
            list-style: none;
            padding-left: 0px;
        }
        .ls-data li {
            display: inline-block;
            padding: 2px 5px;
            background-color: #2a739e;
            border-radius: 3px;
        }
        .ls-data .add {
            cursor: pointer;
        }
        .ls-data .data {
            margin-right: 5px;
        }
        .ls-data .data .remove {
            margin-left: 5px;
            cursor: pointer;
        }

        .floating-button {
            margin-bottom: 5px;
            cursor: pointer;
            color: #97a0b3;
            border-radius: 3px;
            -webkit-box-shadow: none;
            box-shadow: none;
            border: 1px solid transparent;
        }
        .floating-button:hover {
            color: #606c84;
            background-color: #c0c5d2;
            border: 1px solid #97a0b3;
        }
        .box {
            margin-bottom: 5px;
        }
    </style>
</head>
<body class="hold-transition skin-blue sidebar-mini">
    <div class="cover">
        <div class="outer-wrapper">
            <div class="inner-wrapper">
                <div class="loading"></div>
                <div class="loading-text">Preparing workspace</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="login_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="login-modal-container">
                <div style="text-align: center">
                    <img class="logo" src="/static/images/analev-r.png" style="width:80px" />
                </div>

                <form class="login-form" method="post" action="#">
                    <h1>Login to Your Account</h1><br>
                    <div class="alert alert-danger login-error"></div>
                    <input type="text" name="email" placeholder="Email">
                    <input type="password" name="password" placeholder="Password">
                    <input type="submit" class="login login-modal-submit" value="Login">

                    <div class="login-help">
                        <a class="ln-registration" href="#">Register</a> - <a href="#">Forgot Password</a>
                    </div>
                </form>

                <form class="registration-form" method="post" action="#">
                    <h1>Register New Account</h1><br>
                    <div class="alert alert-danger registration-error"></div>
                    <input type="text" name="firstname" placeholder="Firstname">
                    <input type="text" name="lastname" placeholder="Lastname">
                    <input type="text" name="email" placeholder="Email">
                    <input type="password" name="password" placeholder="Password">
                    <input type="password" name="confirm-password" placeholder="Confirm Password">
                    <input type="submit" class="login login-modal-submit" value="Register">

                    <div class="login-help">
                        <a class="ln-login" href="#">Login</a> - <a href="#">Forgot Password</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resend_activation_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="login-modal-container">
                <div style="text-align: center">
                    <img src="/static/images/analev-r.png" style="width:80px" />
                </div>

                <form class="activation-form" method="post" action="#">
                    <h1>Resend Activation Email</h1><br>
                    <div class="alert alert-danger login-error"></div>
                    <input type="text" name="email" placeholder="Email">
                    <input type="submit" class="login login-modal-submit" value="Resend">
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="select_workspace_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="login-modal-container">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img src="/static/images/analev-r.png" style="width:80px" />
                </div>

                <div class="table-responsive">
                    <table id="tbl_select_workspace_list">
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="select_data_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
        <div class="modal-dialog">
            <div class="login-modal-container">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img class="logo" src="/static/images/analev-r.png" style="width:80px" />
                </div>

                <div class="table-responsive">
                    <table id="tbl_select_data_list">
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="wrapper">
        <header class="main-header">
            <!-- Logo -->
            <a href="." class="logo">
                <span class="logo-mini"><b>AeR</b></span>
                <span class="logo-lg">Analev<b>R</b></span>
            </a>

            <!-- Header Navbar: style can be found in header.less -->
            <nav class="navbar navbar-static-top">
                <!-- Sidebar toggle button-->
                <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button">
                    <span class="sr-only">Toggle navigation</span>
                </a>

                <!-- Navbar Right Menu -->
                <div class="navbar-custom-menu">
                    <ul class="nav navbar-nav">
                        <!-- User Account: style can be found in dropdown.less -->
                        <li class="dropdown user user-menu">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <img src="https://image.flaticon.com/icons/png/512/78/78373.png" class="user-image"
                                     alt="User Image">
                                <span class="hidden-xs">{{ user.firstname }} {{ user.lastname }}</span>
                            </a>
                            <ul class="dropdown-menu">
                                <!-- User image -->
                                <li class="user-header">
                                    <img src="https://image.flaticon.com/icons/png/512/78/78373.png"
                                         class="img-circle" alt="User Image">

                                    <p>
                                        {{ user.firstname }} {{ user.lastname }}
                                        <small>Member since Nov. 2012</small>
                                    </p>
                                </li>
                                <!-- Menu Footer-->
                                <li class="user-footer">
                                    <div class="pull-left">
                                        <a href="#" class="btn btn-default btn-flat">Profile</a>
                                    </div>
                                    <div class="pull-right">
                                        <a href="/logout" class="btn btn-default btn-flat" id="btn_logout">Sign out</a>
                                    </div>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Left side column. contains the logo and sidebar -->
        <aside class="main-sidebar">
            <!-- sidebar: style can be found in sidebar.less -->
            <section class="sidebar">
                <!-- Sidebar user panel -->
                <div class="user-panel">
                    <div class="pull-left image">
                        <img src="https://image.flaticon.com/icons/png/512/78/78373.png" class="img-circle"
                             alt="User Image">
                    </div>
                    <div class="pull-left info">
                        <p>{{ user.firstname }} {{ user.lastname }}</p>
                        <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
                    </div>
                </div>

                <!-- sidebar menu: : style can be found in sidebar.less -->
                <ul class="sidebar-menu" data-widget="tree">
                    <li class="header">MAIN NAVIGATION</li>
                    <li class="active">
                        <a href="#" id="btn_browse_workspaces">
                            <i class="fa fa-search"></i> <span>Browse Workspaces</span>
                        </a>
                    </li>
                    <li class="active treeview menu-open">
                        <a href="#">
                            <i class="fa fa-dashboard"></i> <span>Workspaces</span>
                            <span class="pull-right-container">
                                <i class="fa fa-angle-left pull-right"></i>
                            </span>
                        </a>
                        <ul class="treeview-menu list-workspaces"></ul>
                    </li>
                </ul>
            </section>
            <!-- /.sidebar -->
        </aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <section class="content-header">
                <h1>
                    <a href="#" id="notebook-name">{{ session.label }}</a> <small>Unsaved</small>
                </h1>

                <div class="breadcrumb">
                    <button type="button" class="btn btn-box-tool" data-widget="save" title="Save workspace">
                        <i class="fa fa-save"></i>
                    </button>
                    <button type="button" class="btn btn-box-tool" data-widget="download" title="Download workspace">
                        <i class="fa fa-download"></i>
                    </button>
                    <button type="button" class="btn btn-box-tool" data-widget="upload" title="Restore workspace">
                        <i class="fa fa-upload"></i>
                    </button>
                    <button type="button" class="btn btn-box-tool" data-widget="trash" title="Remove workspace">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </section>

            <section class="content-header">
                <div class="alert alert-info">
                    <div><strong>Info</strong> Select data using <i class="fa fa-plus"></i></div>
                    <ul class="ls-data">
                        <li class="add"><i class="fa fa-plus"></i></li>
                    </ul>
                </div>
            </section>

            <!-- Main content -->
            <section class="content">
                <div class="row">
                    <div class="col-md-12 cell">
                        <div class="box">
                            <div class="box-header with-border">
                                <h3 class="box-title"><a href="#" class="cell-title">Untitled Cell</a></h3>

                                <div class="box-tools pull-right">
                                    <button type="button" class="btn btn-box-tool" data-widget="run" title="Run this cell">
                                        <i class="fa fa-play"></i>
                                    </button>
                                    <button type="button" class="btn btn-box-tool" data-widget="insert-up" title="Insert before this cell">
                                        <i class="fa fa-sort-up"></i>
                                    </button>
                                    <button type="button" class="btn btn-box-tool" data-widget="insert-down" title="Insert after this cell">
                                        <i class="fa fa-sort-down"></i>
                                    </button>
                                    <button type="button" class="btn btn-box-tool" data-widget="copy" title="Duplicate this cell">
                                        <i class="fa fa-copy"></i>
                                    </button>
                                    <button type="button" class="btn btn-box-tool" data-widget="collapse" title="Collapse this cell">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                    <button type="button" class="btn btn-box-tool" data-widget="remove2" title="Remove this cell">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="box-body">
                                <div class="row input-wrapper">
                                    <div class="col-md-12">
                                        <textarea style="display:none;" class="cell-input"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="box-footer">
                                <div class="row output-wrapper">
                                    <div class="col-sm-12 col-xs-12 output-table"></div>
                                    <div class="col-sm-12 col-xs-12 output-image"></div>
                                    <div class="col-sm-12 col-xs-12 output-plain">
                                        <textarea style="display:none;" class="cell-output"></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="box-footer">
                                <div class="row time-wrapper">
                                    <div class="col-sm-12 col-xs-12">
                                        Command is executed in <span class="sp-et"></span> ms.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <footer class="main-footer">
            <div class="pull-right hidden-xs">
                <b>Version</b> 0.1
            </div>
            <strong>Copyright &copy; 2018 <a href="http://erikaris.com/">Erikaris</a>. Design by <a href="https://adminlte.io">Admin LTE</a>.</strong>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.3/js/adminlte.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-sparklines/2.1.2/jquery.sparkline.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jvectormap/1.2.2/jquery-jvectormap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jQuery-slimScroll/1.3.8/jquery.slimscroll.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.6.0/Sortable.min.js"></script>
    <script src="https://fastcdn.org/FileSaver.js/1.1.20151003/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.39.0/addon/scroll/simplescrollbars.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/mode/r/r.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.3/js/pages/dashboard2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/2.4.3/js/demo.js"></script>

    <script type="text/javascript">
        var request_url = '{{ request_path }}',
            pathname = '/' + location.pathname.substring(1).replace(request_url.substring(1), ''),
            context_url = location.protocol + '//' + location.host + (pathname.length > 0 ? pathname : ''),
            $loading_cover = $('.cover'),
            $loading_indicator = $('.loading'),
            $loading_text = $('.loading-text'),
            $logo = $('.logo');

        if (context_url.substring(context_url.length-1) == '/') {
            context_url = context_url.substring(0, context_url.length-1);
        }

        $.post(context_url + '/base_url/', {
            'base_url': context_url
        }, function(resp) {});

        $logo.attr('src', context_url + '/static/images/analev-r.png');
        $loading_indicator.css('background', 'url(' + context_url + '/static/images/loading.gif)');

        {% if user is none %}
            $loading_text.html('You are not authenticated!');

            $('#login_modal').find('.registration-form').attr('action', context_url + '/register');
            $('#login_modal').find('.login-form').attr('action', context_url + '/login?next=' + request_url);
            $('#login_modal').modal();

            $('.ln-registration').on('click', function() {
                $('.registration-form').fadeIn();
                $('.login-form').hide();
            });

            $('.ln-login').on('click', function() {
                $('.registration-form').hide();
                $('.login-form').fadeIn();
            });

            {% if page == 'registration' %}
                $('.registration-form').fadeIn();
                $('.login-form').hide();

                {% if error is not none %}
                    $('#login_modal').find('.registration-error').html('{{ error }}').show();
                    $('#login_modal').find('.registration-form [name=firstname]').val('{{ registration_data.firstname }}');
                    $('#login_modal').find('.registration-form [name=lastname]').val('{{ registration_data.lastname }}');
                    $('#login_modal').find('.registration-form [name=email]').val('{{ registration_data.email }}');
                {% endif %}
            {% else %}
                {% if error is not none %}
                    $('#login_modal').find('.login-error').show().html(htmlDecode('{{ error }}'));
                    $('.ln-resend-activation-email').on('click', function(e) {
                        e.preventDefault();
                        $('#resend_activation_modal').find('.activation-form').attr('action', context_url + '/resend-activation');
                        $('#resend_activation_modal').modal();
                        return false;
                    });
                {% endif %}
            {% endif %}
        {% else %}
            $loading_text.html('Preparing workspace...');

            {% if session is none %}
                $loading_text.html('Requested session is not found! Redirecting to first workspace...');

                $.ajax(context_url + '/api/session/list/user/{{ user.id }}').done(function(resp) {
                    if (resp.success) {
                        if (resp.data.length > 0) {
                            location.href = context_url + '/session/' + resp.data[0].id;
                        } else {
                            $loading_text.html('No session found! Creating initial workspace...');

                            $.post(context_url + '/api/session/create/', {
                                'user_id': '{{ user.id }}'
                            }, function(resp) {
                                $loading_text.html('Redirecting to target workspace...');

                                session_id = resp.data;
                                location.href = context_url + '/session/' + session_id;
                            });
                        }
                    }
                });
            {% else %}
                $loading_text.html('Starting session...');

                function delete_workspace(workspace_id) {
                    title = $('.workspace [workspace-id=' + workspace_id + '] .title').html();
                    bootbox.confirm('Are you sure to remove workspace "' + title + '"?', function(yes) {
                        if (yes) {
                            $.post(context_url + '/api/session/delete/' + workspace_id, {
                                'user_id': '{{ user.id }}'
                            }, function(resp) {
                                if (resp.success) {
                                    location.href = context_url;
                                }
                            });
                        }
                    });
                }

                $.post(context_url + '/api/session/start/{{ session.id }}', function(resp) {
                    if (resp.success) {
                        $loading_text.html('Initializing workspace...');

                        $('#btn_logout').attr('href', context_url + '/logout');

                        // Restoring workspace data
                        saved = JSON.parse(resp.data);
                        if ('data' in saved) {
                            data = saved.data,
                            cells = saved.cells || saved.paragraphs;
                        } else {
                            data = [],
                            cells = saved;
                        }

                        data.forEach(function(d) {
                            $('<li class="data" var-index="' + d.variable_idx + '">' +
                                'df' + d.variable_idx + ' = ' + d.label +
                                '<span class="remove"><i class="fa fa-close"></i></span>' +
                            '</li>').data(d).insertBefore($('.ls-data .add'));
                        });

                        $addb = $('.floating-button-wrapper:first');
                        $par = $('.cell');
                        for(p=0; p<cells.length-1; p++) {
                            $par.clone().insertAfter($par);
                            $addb.clone().insertAfter($par);
                        }

                        $pars = $('.cell');
                        cells.forEach(function(data, p) {
                            $title = $($pars[p]).find('.cell-title').html(data.title);
                            $input = $($pars[p]).find('.cell-input').val(data.input);
                            $output_table = $($pars[p]).find('.output-table').html(data.output.table);
                            $output_image = $($pars[p]).find('.output-image').html(data.output.image);
                            $output_plain = $($pars[p]).find('.output-plain .cell-output').val(data.output.plain);

                            if(data.output.table != "") $output_table.show();
                            if(data.output.image != "") $output_image.show();
                            if(data.output.plain != "") {
                                $output_plain.show().parent().show();
                                $output_plain.codemirror({
                                    'mode': 'r',
                                    'lineNumbers': true,
                                    'indentUnit': 2,
                                    'readOnly': true,
                                    'scrollbarStyle': 'overlay'
                                });
                            }
                        });

                        $('.input-wrapper textarea').codemirror({
                            'mode': 'r',
                            'lineNumbers': true,
                            'indentUnit': 2,
                            'tabSize': 2,
                            'indentWithTabs': true,
                            'scrollbarStyle': 'overlay'
                        });

                        $.fn.editable.defaults.mode = 'inline';
                        $('#notebook-name').editable({
                            type: 'text',
                            pk: '{{ session.id }}',
                            url: context_url + '/api/session/title',
                            title: 'Enter notebook name'
                        });

                        $('.cell-title').editable({
                            type: 'text',
                            pk: '{{ session.id }}',
                            url: context_url + '/api/session/fake',
                            title: 'Enter cell name'
                        });

                        Sortable.create($('.content .row')[0], {
                            handle: ".box-header"
                        });

                        // Disable some controls when not owner
                        {% if user.id != session.user_id %}
                            $('[data-widget=save]').remove();
                            $('[data-widget=upload]').remove();
                            $('[data-widget=trash]').remove();
                            $('[data-widget=run]').remove();
                            $('[data-widget=copy]').remove();
                            $('[data-widget=insert-up]').remove();
                            $('[data-widget=insert-down]').remove();
                            $('.ls-data .data .remove').remove();
                            $('.ls-data .add').remove();
                        {% endif %}

                        $.ajax(context_url + '/api/session/list/user/{{ user.id }}').done(function(resp) {
                            if (resp.success) {
                                resp.data.forEach(function(sess) {
                                    $('<li workspace-id="' + sess.id + '" class="workspace' + (sess.id == '{{ session.id }}' ? ' active' : '') + '">' +
                                        '<a href="' + context_url + '/session/' + sess.id + '">' +
                                            '<i class="fa fa-circle-o"></i>' + 
                                            '<span class="title">' + sess.label + '</span>' + 
                                        '</a>' +
                                        '<a href="#" class="close"><i class="fa fa-close"></i></a>' +
                                    '</li>').appendTo($('.list-workspaces'));
                                });

                                $('.list-workspaces li .close').on('click', function() {
                                    $li = $(this).parents().filter(function() {
                                        if ($(this).addClass('workspace')) return true;
                                        return false;
                                    });

                                    workspace_id = $li.attr('workspace-id');
                                    delete_workspace(workspace_id);
                                });

                                if (resp.data.length < 10) {
                                    $new_ws = $('<li class="create">' +
                                        '<a href="#"><i class="fa fa-plus"></i>New Workspace</a>' +
                                    '</li>').appendTo($('.list-workspaces'));

                                    $new_ws.find('a').on('click', function() {
                                        $.post(context_url + '/api/session/create/', {
                                            'user_id': '{{ user.id }}'
                                        }, function(resp) {
                                            session_id = resp.data;
                                            location.href = context_url + '/session/' + session_id;
                                        });
                                    });
                                }
                            }
                        });

                        $(document).on('click', '#btn_browse_workspaces', function() {
                            $('#select_workspace_modal').modal();
                        });

                        $('#select_workspace_modal').on('show.bs.modal', function (e) {
                            var $modal = $(this);

                            $.get(context_url + '/api/session/list', function(resp) {
                                if (resp.success) {
                                    $tbody = $('#tbl_select_workspace_list tbody').empty();
                                    resp.data.forEach(function(d) {
                                        $('<tr session-id="' + d.id + '" class="data-item" style="cursor: pointer;">' +
                                            '<td>' +
                                                '<a href="' + context_url + '/session/' + d.id + '"><span>' + d.label + '</span></a>' +
                                            '</td>' +
                                        '</tr>').data(d).appendTo($tbody);
                                    });
                                }
                            });
                        });

                        $(document).on('click', '.ls-data .add', function() {
                            $('#select_data_modal').modal();
                        });

                        $('#select_data_modal').on('show.bs.modal', function (e) {
                            var $modal = $(this);

                            $.get(context_url + '/api/data/list', function(resp) {
                                if (resp.success) {
                                    $tbody = $('#tbl_select_data_list tbody').empty();
                                    resp.data.forEach(function(d) {
                                        $('<tr data-id="' + d.id + '" class="data-item" style="cursor: pointer;">' +
                                            '<td>' +
                                                '<span>' + d.label + '</span>' +
                                            '</td>' +
                                        '</tr>').data(d).appendTo($tbody);
                                    });

                                    $modal.find('#tbl_select_data_list .data-item').on('click', function() {
                                        var $data = $(this),
                                            data = $data.data(),
                                            idx = 0;

                                        for(var d=0; d<=$('.ls-data').find('.data').length+1; d++) {
                                            $eli = $('.ls-data').find('.data[var-index=' + d + ']');
                                            if ($eli.length == 0) {
                                                idx = d;
                                                break;
                                            }
                                        }

                                        $.post(context_url + '/api/session/eval/{{ session.id }}/return/0', {
                                            'user_id': '{{ user.id }}',
                                            'cmd': 'df' + idx + ' <- ' + data.r_handler.replace('?', '"' + data.original_filename + '"'); + '\n' +
                                                   'head(df' + idx + ')',
                                        }, function (resp2) {
                                            if (resp2.success) {
                                                $('<li class="data" var-index="' + idx + '">' +
                                                    'df' + idx + ' = ' + data.label +
                                                    '<span class="remove"><i class="fa fa-close"></i></span>' +
                                                '</li>').data(data).insertBefore($('.ls-data .add'));
                                                $modal.modal('hide');
                                            }
                                        });
                                    });
                                }
                            });
                        });

                        $(document).on('click', '.ls-data .data .remove', function() {
                            $li_data = $(this).parents().filter(function() {
                                if ($(this).hasClass('data')) return true;
                                return false;
                            });

                            $.post(context_url + '/api/session/eval/{{ session.id }}', {
                                'user_id': '{{ user.id }}',
                                'cmd': 'rm(df' + $li_data.attr('var-index') + ')'
                            }, function (resp2) {
                                if (resp2.success) {
                                    $li_data.remove();
                                }
                            });
                        });

                        $(document).on('click', '.btn[data-widget=save]', function() {
                            var data = $('.ls-data .data').toArray().map(function(d) {
                                var _d = $(d).data();
                                _d['variable_idx'] = $(d).attr('var-index');
                                return _d;
                            });

                            var cells = [];
                            $('.cell').each(function() {
                                $title = $(this).find('.cell-title');
                                $input = $(this).find('.cell-input');
                                $output_table = $(this).find('.output-table');
                                $output_image = $(this).find('.output-image');
                                $output_plain = $(this).find('.output-plain .cell-output').data('codemirror');

                                cells.push({
                                    'title' : $title.html(),
                                    'input' : $input.data('codemirror').getValue(),
                                    'output' : {
                                        'table': $output_table.html(),
                                        'image': $output_image.html(),
                                        'plain': $output_plain ? $output_plain.getValue() : ''
                                    },
                                });
                            });

                            var to_save = {
                                'data': data,
                                'paragraphs': cells
                            };

                            $.post(context_url + '/api/session/save/{{ session.id }}', {
                                'user_id': '{{ user.id }}',
                                'content': JSON.stringify(to_save, null, 4)
                            }, function(resp) {

                            });
                        });

                        $(document).on('click', '.btn[data-widget=download]', function() {
                            $('<form class="form-download-workspace" method="get" action="' + context_url + '/api/session/download/{{ session.id }}' + '"><button type="submit" style="display:none"></button></form>')
                            .appendTo($('body'))
                            .submit();
                        });

                        $(document).on('click', '.btn[data-widget=upload]', function() {
                            $form = $('<form class="form-upload-workspace" method="post" enctype="multipart/form-data" action="' + context_url + '/api/session/upload/{{ session.id }}' + '">' + 
                                '<input type="file"/>' + 
                                '<button type="submit">' + 
                            '</button></form>')
                            .appendTo($('body'));

                            $form.on('submit', function(e) {
                                files = $form.find('input[type=file]')[0].files;
                                $.each(files, function(key, file) {
                                    var formData = new FormData();
                                    formData.append("file", file);

                                    $.ajax({
                                        url: $form.attr("action"),
                                        data: formData,
                                        cache: false,
                                        contentType: false,
                                        processData: false,
                                        method: 'POST',
                                        success: function(resp){
                                            if (resp.success) {
                                                location.reload();
                                            }
                                        }
                                    });
                                });

                                return false;
                            });

                            $form.find('input[type=file]').on('change', function(e) {
                                $form.submit();
                            });

                            $form.find('input[type=file]').trigger('click');
                        });

                        $(document).on('click', '.btn[data-widget=trash]', function() {
                            delete_workspace('{{ session.id }}');
                        });

                        $(document).on('click', '.btn[data-widget=run]', function() {
                            var $btn_run = $(this);
                            $btn_run.parents().each(function() {
                                $par = $(this);
                                if ($par.hasClass('box')) {
                                    $input = $par.find('.input-wrapper textarea').data('codemirror');
                                    $par.find('.output-wrapper [class*="output-"]').hide();

                                    $.post(context_url + '/api/session/eval/{{ session.id }}', {
                                        'user_id': '{{ user.id }}',
                                        'cmd': $input.getValue()
                                    }, function(resp) {
                                        $par = $btn_run.parents().filter(function() {
                                            if ($(this).hasClass('box')) return true;
                                            return false;
                                        });

                                        if (resp.success) {
                                            var type = resp.data.type,
                                                text = resp.data.text,
                                                time = resp.data.time.elapsed;

                                            $par.find('.time-wrapper .sp-et').html(time);

                                            $par.find('.output-wrapper .output-table, .output-wrapper .output-image').html('');
                                            $par.find('.output-wrapper .output-plain').find('.CodeMirror').remove();
                                            $par.find('.output-wrapper .output-plain textarea').val('');

                                            if (type == 'plain') {
                                                $par = $par.find('.output-wrapper .output-plain')
                                                    .show();
                                                $par.find('.CodeMirror').remove();
                                                $par.find('textarea').val(text).codemirror({
                                                    'mode': 'r',
                                                    'lineNumbers': true,
                                                    'indentUnit': 2,
                                                    'readOnly': true,
                                                    'scrollbarStyle': 'overlay'
                                                });
                                            } else if(type == 'table') {
                                                $par.find('.output-wrapper .output-table')
                                                    .html('<div class="table-responsive">' + text + '</div>')
                                                    .show();

                                                $par.find('.output-wrapper .output-table table').addClass('table');
                                            } else if(type == 'image') {
                                                $par.find('.output-wrapper .output-image')
                                                    .html('<img src="data:image/png;base64,' + text + '" >')
                                                    .show();
                                            }
                                        } else {
                                            $par = $par.find('.output-wrapper .output-plain')
                                                .show();
                                            $par.find('.CodeMirror').remove();
                                            $par.find('textarea').val(resp.message).codemirror({
                                                'mode': 'r',
                                                'lineNumbers': true,
                                                'indentUnit': 2,
                                                'readOnly': true,
                                                'scrollbarStyle': 'overlay'
                                            });
                                        }

                                        $(document).find('.btn[data-widget=save]').click();
                                    });
                                }
                            });
                        });

                        $(document).on('click', '.btn[data-widget=copy]', function() {
                            $(this).parents().each(function() {
                                $par = $(this);
                                if ($par.attr('class') != null && $par.attr('class').indexOf('col-') >= 0) {
                                    $cpar = $par.clone();
                                    $cpar.insertAfter($par);
                                    $cpar.find('.CodeMirror').remove();
                                    $cpar.find('.input-wrapper textarea')
                                        .val($par.find('.input-wrapper textarea').data('codemirror').getValue())
                                        .codemirror({
                                            'mode': 'r',
                                            'lineNumbers': true,
                                            'indentUnit': 2,
                                            'tabSize': 2,
                                            'indentWithTabs': true,
                                            'scrollbarStyle': 'overlay'
                                        });
                                }
                            });

                            $('.cell-title').editable({
                                type: 'text',
                                pk: '{{ session.id }}',
                                url: context_url + '/api/session/fake',
                                title: 'Enter cell name'
                            });
                        });

                        function insert_box(curr_box, is_after = true) {
                            if (is_after) $new_box = $(curr_box).clone().insertAfter($box);
                            else $new_box = $(curr_box).clone().insertBefore($box);

                            $new_box.find('.CodeMirror').remove();
                            $new_box.find('.input-wrapper textarea').val('')
                                .codemirror({
                                    'mode': 'r',
                                    'lineNumbers': true,
                                    'indentUnit': 2,
                                    'tabSize': 2,
                                    'indentWithTabs': true,
                                    'scrollbarStyle': 'overlay'
                                });

                            $new_box.find('.time-wrapper .sp-et').html('');
                            $new_box.find('.output-wrapper .output-table, .output-wrapper .output-image').html('');
                            $new_box.find('.output-wrapper .output-plain').find('.CodeMirror').remove();
                            $new_box.find('.output-wrapper .output-plain textarea').val('');

                            $new_box.find('.cell-title').html('Untitled Cell').editable({
                                type: 'text',
                                pk: '{{ session.id }}',
                                url: context_url + '/api/session/fake',
                                title: 'Enter cell name'
                            });
                        }

                        $(document).on('click', '[data-widget=insert-up]', function() {
                            $box = $(this).parents().filter(function() {
                                if ($(this).hasClass('cell')) return true;
                                return false;
                            });

                            insert_box($box, false);
                        });

                        $(document).on('click', '[data-widget=insert-down]', function() {
                            $box = $(this).parents().filter(function() {
                                if ($(this).hasClass('cell')) return true;
                                return false;
                            });

                            insert_box($box, true);
                        });

                        $(document).on('click', '[data-widget=remove2]', function() {
                            $par = $(this).parents().filter(function() {
                                if($(this).hasClass('box-header')) return true;
                                return false;
                            });

                            title = $par.find('.box-title a').html();

                            bootbox.confirm('Are you sure to remove cell "' + title + '"?', function(yes) {
                                if (yes) {
                                    $par = $par.parents().filter(function() {
                                        if($(this).hasClass('cell')) return true;
                                        return false;
                                    });

                                    $par.slideUp("normal", function() { $par.remove(); } );
                                }
                            });
                        });

                        $loading_cover.fadeOut();
                    }
                });
            {% endif %}
        {% endif %}

        setTimeout(function() {
            $('[href="https://themequarry.com"]').parent().remove();
        }, 1000);
    </script>
</body>
</html>
